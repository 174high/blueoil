# Conv Sample
HLS example code for convolution


# Requirement
Quartus Prime 18.0 
python 3.6.3 ~
C++ Compiler Toolchain 4.7 ~
C++ Arm Cross Compiler Toolchain Toolchain (option) 4.7 ~



# Getting started 
You can use some automation scripts to generate your design.
when you expect to run one of the following steps, all you need to do is just calling `build.py` from your shell.

1. sim     : HLS simulation
1. syn     : HLS synthesis
1. qsys    : Qsys HDL generation
1. quartus : Quartus Compilation
1. bsp     : BSP configuration

The left short characters is what we call `symbol` and the right is the explanation. 

`build.py` sequentially calls the every flow after the given symbol from shell by following to run.

```
python python/build.py {device_name} {symbol} {IP_name}
```

For instance, if you expect to run the all steps after HLS simulation on DE10-Nano evaluation board,
the command is going to be like

```
python python/build.py intel/de10-nano sim qconv1x1
```


## Device Name

Here, `intel/de10-nano` is the board name you expect to run your load module on.
The naming rule is `{vendor}/{board_name}`, but it's just temporary.
Also `qconv1x1` is a IP name that is going to tell qsys editor the location of the IP in file system.
**Now we support only `qconv1x1`, please just type it without a change. We support other IP in the future.**


## Quartus Compile
If you only need to run after quartus steps, you can command like
```
python python/build.py intel/de10-nano quartus qconv1x1
```

After this step, you can see `{board_name}.prj` directory that contains the any files related to Quartus.
If your device_name is `intel/de10_nano`, the directory become `de10_nano.prj`.


## Boot file generation
After you've done your execution until `bsp` step, 
Finally you can see the boot files, such as .rbf, in `{board_name}.prj/bootfiles` directory like below.
```
> ls de10-nano.prj/bootfiles/
preloader-mkpimage.bin  soc_system.rbf  u-boot.img
```


# Manually build
All steps you saw above are available separately as a make target also.
You can use this way when you want to run a specific step on your purpose with the symbols we already describe above.
For example,

- `make x86`
- `make sim`
- `make syn`
- `make arm`
- `make fpga`

**It's only available with an arm cross compiler.**


# How to setup a board

This document describes how to setup an environment to run library generated by DLK on a DE10-Nano board.
We need the host system which has microSD card reader.
All example commands are in case you use Linux or MacOS. If you use other system, commands will have some differences.

## Create Linux system on microSD card (On host)

At first we need to get the Linux image.
The image is available from the Terasic web site and please follow the link as below:

1. Go to [Terasic's official web site](https://www.terasic.com.tw/en/)
2. Select "Products"
3. Select "DE10-Nano Kit"
4. Select "Resources"
5. Select "Linux BSP (Board Support Package): MicroSD Card Image"
6. Select "Linux LXDE Desktop (kernel 4.5)"

Note: A user registration is required to download the image.

Downloaded file contains the "DE10_Nano_LXDE.img".
Please set the empty microSD card into your system and write the downloaded image to microSD card as below.

    $ sudo dd if=DE10_Nano_LXDE.img of=/dev/mmcblk0 bs=128M && sync

Caution & Note:
- In Linux 
    -  /dev/xxx might have different name and please make sure the device name of target microSD
- In MacOS
    - /dev/xxx has different name and please make sure the device name of target microSD
    - bs option of dd command should be changed to bs=128m

Please unset the microSD from your host system after dd && sync operation has been finished. And please set the microSD again for further operations.


# Update some files for DLK (On host)

We need to update some files of microSD. 
To update it, we need to perform some copy operations.

Required files are shown in the following list. These files are necessary in later step.

    de10-nano.prj/
    |
    |- bootfiles/u-boot.img
    |- bootfiles/soc_system.rbf
    |- bootfiles/preloader-mkpimage.bin

Note: u-boot.img is not needed to update.

And the actual copy operations should be executed as below. It's assumed that all required files are put on the REQUIRED_FILES directory.

    $ cd REQUIRED_FILES
    $ mkdir /mnt/media
    $ mount -t vfat /dev/mmcblk0p1 /mnt/media
    $ cp soc_system.rbf /mnt/media
    $ dd if=preloader-mkpimage.bin of=/dev/mmcblk0p3 bs=64 && sync
